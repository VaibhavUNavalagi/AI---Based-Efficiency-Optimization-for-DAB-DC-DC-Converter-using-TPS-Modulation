<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAB Converter TPS Optimization Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.2rem;
            color: #666;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .control-panel h3 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .control-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .control-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        .control-group input,
        .control-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0.25rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.secondary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }

        .btn.success {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .status-bar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .status-item {
            text-align: center;
            flex: 1;
        }

        .status-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
        }

        .status-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1rem;
            text-align: center;
        }

        .running {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .metric-card h4 {
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .metric-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }

        .metric-card .unit {
            font-size: 0.9rem;
            color: #666;
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>‚ö° DAB Converter TPS Optimization Dashboard</h1>
            <p>Triple Phase Shift Modulation using Q-Learning Reinforcement Learning</p>
        </div>

        <div class="controls">
            <div class="control-panel">
                <h3>‚öôÔ∏è Converter Parameters</h3>
                <div class="control-group">
                    <div>
                        <label>Input Voltage V1 (V)</label>
                        <input type="number" id="V1" value="100" min="50" max="500" step="10">
                    </div>
                    <div>
                        <label>Output Voltage V2 (V)</label>
                        <input type="number" id="V2" value="50" min="20" max="200" step="5">
                    </div>
                </div>
                <div class="control-group">
                    <div>
                        <label>Leakage Inductance (¬µH)</label>
                        <input type="number" id="Lk" value="15" min="5" max="50" step="1">
                    </div>
                    <div>
                        <label>Switching Frequency (kHz)</label>
                        <input type="number" id="fs" value="50" min="10" max="200" step="5">
                    </div>
                </div>
                <div class="control-group">
                    <div>
                        <label>Turns Ratio</label>
                        <input type="number" id="n" value="2" min="1" max="10" step="0.1">
                    </div>
                    <div>
                        <label>Nominal Power (W)</label>
                        <input type="number" id="Pnom" value="1000" min="100" max="5000" step="100">
                    </div>
                </div>
            </div>

            <div class="control-panel">
                <h3>üéØ Optimization Settings</h3>
                <div class="control-group">
                    <div>
                        <label>Target Power (W)</label>
                        <input type="number" id="targetPower" value="500" min="100" max="2000" step="50">
                    </div>
                    <div>
                        <label>Training Episodes</label>
                        <input type="number" id="episodes" value="1000" min="100" max="5000" step="100">
                    </div>
                </div>
                <div class="control-group">
                    <div>
                        <label>Learning Rate</label>
                        <input type="number" id="learningRate" value="0.1" min="0.01" max="0.5" step="0.01">
                    </div>
                    <div>
                        <label>Exploration Rate</label>
                        <input type="number" id="explorationRate" value="1.0" min="0.1" max="1.0" step="0.1">
                    </div>
                </div>
                <div style="text-align: center; margin-top: 1rem;">
                    <button class="btn success" onclick="startOptimization()">‚ñ∂Ô∏è Start Optimization</button>
                    <button class="btn secondary" onclick="stopOptimization()">‚èπÔ∏è Stop</button>
                    <button class="btn" onclick="resetOptimization()">üîÑ Reset</button>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-value" id="statusValue">READY</div>
                <div class="status-label">Status</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="episodeValue">0</div>
                <div class="status-label">Episode</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="powerValue">0</div>
                <div class="status-label">Power (W)</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="rewardValue">0</div>
                <div class="status-label">Reward</div>
            </div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <h4>Phase Shift D1</h4>
                <div class="value" id="d1Value">0.000</div>
                <div class="unit">Bridge Phase</div>
            </div>
            <div class="metric-card">
                <h4>Phase Shift D2</h4>
                <div class="value" id="d2Value">0.000</div>
                <div class="unit">Primary Duty</div>
            </div>
            <div class="metric-card">
                <h4>Phase Shift D3</h4>
                <div class="value" id="d3Value">0.000</div>
                <div class="unit">Secondary Duty</div>
            </div>
            <div class="metric-card">
                <h4>RMS Current</h4>
                <div class="value" id="currentValue">0.0</div>
                <div class="unit">Amperes</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-title">üìà Power Tracking</div>
                <div id="powerChart"></div>
            </div>
            <div class="chart-container">
                <div class="chart-title">üéØ Reward Evolution</div>
                <div id="rewardChart"></div>
            </div>
            <div class="chart-container">
                <div class="chart-title">üîÑ Phase Shifts Evolution</div>
                <div id="phaseChart"></div>
            </div>
            <div class="chart-container">
                <div class="chart-title">‚ö° Current vs Power</div>
                <div id="currentPowerChart"></div>
            </div>
            <div class="chart-container">
                <div class="chart-title">üìä Power Distribution</div>
                <div id="powerHistogram"></div>
            </div>
            <div class="chart-container">
                <div class="chart-title">üé™ 3D Phase Space</div>
                <div id="phase3DChart"></div>
            </div>
        </div>
    </div>

    <script>
        class DABConverter {
            constructor(V1, V2, Lk, fs, n, Pnom) {
                this.V1 = V1;
                this.V2 = V2;
                this.Lk = Lk * 1e-6;
                this.fs = fs * 1e3;
                this.n = n;
                this.Pnom = Pnom;
                this.dt_max = 0.5;
                this.Ts = 1 / this.fs;
                this.k = V2 / V1;
                this.Zbase = 8 * this.fs * this.Lk;
                this.Pbase = (this.V1 ** 2) / this.Zbase;
            }

            calculatePower(D1, D2, D3) {
                D1 = Math.max(-this.dt_max, Math.min(this.dt_max, D1));
                D2 = Math.max(0, Math.min(this.dt_max, D2));
                D3 = Math.max(0, Math.min(this.dt_max, D3));

                let p;
                if (D1 >= 0) {
                    if (D1 <= D3 && D1 <= D2) {
                        p = D1 * (1 - D1) - Math.pow(D2 - D1, 2) / 2 - Math.pow(D3 - D1, 2) / 2;
                    } else if (D2 <= D1 && D2 <= D3) {
                        p = D2 * (1 - D2 / 2) + D1 * (D2 - D1) - Math.pow(D3 - D1, 2) / 2;
                    } else if (D3 <= D1 && D3 <= D2) {
                        p = D3 * (1 - D3 / 2) + D1 * (D3 - D1) - Math.pow(D2 - D1, 2) / 2;
                    } else {
                        p = D1 + D2 * (D3 - D2 / 2) + D3 * (D2 - D3 / 2);
                    }
                } else {
                    let D1_abs = Math.abs(D1);
                    if (D1_abs <= D3 && D1_abs <= D2) {
                        p = D1_abs * (1 - D1_abs) - Math.pow(D2 - D1_abs, 2) / 2 - Math.pow(D3 - D1_abs, 2) / 2;
                    } else if (D2 <= D1_abs && D2 <= D3) {
                        p = D2 * (1 - D2 / 2) + D1_abs * (D2 - D1_abs) - Math.pow(D3 - D1_abs, 2) / 2;
                    } else if (D3 <= D1_abs && D3 <= D2) {
                        p = D3 * (1 - D3 / 2) + D1_abs * (D3 - D1_abs) - Math.pow(D2 - D1_abs, 2) / 2;
                    } else {
                        p = D1_abs + D2 * (D3 - D2 / 2) + D3 * (D2 - D3 / 2);
                    }
                    p = -p;
                }

                const normalized_power = this.k * p;
                const p_actual = normalized_power * this.Pbase;
                return { normalized: normalized_power, actual: p_actual };
            }

            calculateRMSCurrent(D1, D2, D3) {
                const { normalized: p_norm } = this.calculatePower(D1, D2, D3);
                const i_rms_squared = Math.abs(p_norm) * (Math.abs(D1) + D2 + D3) / 3;
                const i_rms_normalized = Math.sqrt(i_rms_squared);
                const i_base = this.V1 / this.Zbase;
                const i_rms_actual = i_rms_normalized * i_base;
                return { normalized: i_rms_normalized, actual: i_rms_actual };
            }
        }

        let dab = null;
        let optimizationData = [];
        let isRunning = false;
        let currentEpisode = 0;
        let maxEpisodes = 1000;
        let targetPower = 500;
        let intervalId = null;

        function initializeCharts() {
            const chartConfig = {
                displayModeBar: false,
                responsive: true
            };

            const axisStyle = {
                titlefont: { size: 14 },
                automargin: true,
                title: {
                    standoff: 10
                }
            };

            const layoutBase = {
                autosize: true,
                margin: { l: 60, r: 40, t: 30, b: 60 },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { family: 'Arial, sans-serif', size: 12 }
            };

            // Power Tracking
            Plotly.newPlot('powerChart', [], {
                ...layoutBase,
                xaxis: { ...axisStyle, title: 'Episode' },
                yaxis: { ...axisStyle, title: 'Power (W)' }
            }, chartConfig);

            // Reward Evolution
            Plotly.newPlot('rewardChart', [], {
                ...layoutBase,
                xaxis: { ...axisStyle, title: 'Episode' },
                yaxis: { ...axisStyle, title: 'Reward' }
            }, chartConfig);

            // Phase Shifts Evolution
            Plotly.newPlot('phaseChart', [], {
                ...layoutBase,
                xaxis: { ...axisStyle, title: 'Episode' },
                yaxis: { ...axisStyle, title: 'Phase Shift (D1, D2, D3)' }
            }, chartConfig);

            // Current vs Power
            Plotly.newPlot('currentPowerChart', [], {
                ...layoutBase,
                xaxis: { ...axisStyle, title: 'Power (W)' },
                yaxis: { ...axisStyle, title: 'RMS Current (A)' }
            }, chartConfig);

            // Power Histogram
            Plotly.newPlot('powerHistogram', [], {
                ...layoutBase,
                xaxis: { ...axisStyle, title: 'Power (W)' },
                yaxis: { ...axisStyle, title: 'Frequency' }
            }, chartConfig);

            // 3D Phase Space
            Plotly.newPlot('phase3DChart', [], {
                ...layoutBase,
                scene: {
                    xaxis: { title: 'D1 (Bridge Phase Shift)', automargin: true },
                    yaxis: { title: 'D2 (Primary Duty)', automargin: true },
                    zaxis: { title: 'D3 (Secondary Duty)', automargin: true }
                }
            }, chartConfig);
        }


        function updateCharts() {
            if (optimizationData.length === 0) return;

            const episodes = optimizationData.map(d => d.episode);
            const powers = optimizationData.map(d => d.power);
            const rewards = optimizationData.map(d => d.reward);
            const d1s = optimizationData.map(d => d.D1);
            const d2s = optimizationData.map(d => d.D2);
            const d3s = optimizationData.map(d => d.D3);
            const currents = optimizationData.map(d => d.current);

            const baseLayout = {
                margin: { l: 60, r: 40, t: 30, b: 60 },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { family: 'Arial, sans-serif', size: 12 }
            };

            const axisStyle = {
                titlefont: { size: 14 },
                automargin: true,
                title_standoff: 10
            };

            // 1. Power Tracking
            Plotly.react('powerChart', [
                {
                    x: episodes,
                    y: powers,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Actual Power',
                    line: { color: '#667eea', width: 2 }
                },
                {
                    x: episodes,
                    y: Array(episodes.length).fill(targetPower),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Target Power',
                    line: { color: 'red', width: 2, dash: 'dash' }
                }
            ], {
                ...baseLayout,
                xaxis: { title: 'Episode', ...axisStyle },
                yaxis: { title: 'Power (W)', ...axisStyle }
            });

            // 2. Reward Evolution
            Plotly.react('rewardChart', [{
                x: episodes,
                y: rewards,
                type: 'scatter',
                mode: 'lines',
                name: 'Reward',
                line: { color: '#764ba2', width: 2 }
            }], {
                ...baseLayout,
                xaxis: { title: 'Episode', ...axisStyle },
                yaxis: { title: 'Reward', ...axisStyle }
            });

            // 3. Phase Shifts Evolution
            Plotly.react('phaseChart', [
                {
                    x: episodes,
                    y: d1s,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'D1 (Bridge)',
                    line: { color: 'red', width: 2 }
                },
                {
                    x: episodes,
                    y: d2s,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'D2 (Primary)',
                    line: { color: 'green', width: 2 }
                },
                {
                    x: episodes,
                    y: d3s,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'D3 (Secondary)',
                    line: { color: 'blue', width: 2 }
                }
            ], {
                ...baseLayout,
                xaxis: { title: 'Episode', ...axisStyle },
                yaxis: { title: 'Phase Shift (D1, D2, D3)', ...axisStyle }
            });

            // 4. Current vs Power
            Plotly.react('currentPowerChart', [{
                x: powers,
                y: currents,
                type: 'scatter',
                mode: 'markers',
                name: 'Current vs Power',
                marker: {
                    color: rewards,
                    colorscale: 'Viridis',
                    size: 8,
                    colorbar: { title: 'Reward' }
                }
            }], {
                ...baseLayout,
                xaxis: { title: 'Power (W)', ...axisStyle },
                yaxis: { title: 'RMS Current (A)', ...axisStyle }
            });

            // 5. Power Histogram
            Plotly.react('powerHistogram', [{
                x: powers,
                type: 'histogram',
                nbinsx: 30,
                name: 'Power Distribution',
                marker: { color: '#667eea' }
            }], {
                ...baseLayout,
                xaxis: { title: 'Power (W)', ...axisStyle },
                yaxis: { title: 'Frequency', ...axisStyle }
            });

            // 6. 3D Phase Space
            Plotly.react('phase3DChart', [{
                x: d1s,
                y: d2s,
                z: d3s,
                type: 'scatter3d',
                mode: 'markers',
                marker: {
                    color: rewards,
                    colorscale: 'Viridis',
                    size: 5,
                    colorbar: { title: 'Reward' }
                }
            }], {
                ...baseLayout,
                scene: {
                    xaxis: { title: 'D1 (Bridge Phase Shift)', automargin: true, titlefont: { size: 14 } },
                    yaxis: { title: 'D2 (Primary Duty)', automargin: true, titlefont: { size: 14 } },
                    zaxis: { title: 'D3 (Secondary Duty)', automargin: true, titlefont: { size: 14 } }
                }
            });
        }


        function startOptimization() {
            if (isRunning) return;

            // Get parameters from inputs
            const V1 = parseFloat(document.getElementById('V1').value);
            const V2 = parseFloat(document.getElementById('V2').value);
            const Lk = parseFloat(document.getElementById('Lk').value);
            const fs = parseFloat(document.getElementById('fs').value);
            const n = parseFloat(document.getElementById('n').value);
            const Pnom = parseFloat(document.getElementById('Pnom').value);

            targetPower = parseFloat(document.getElementById('targetPower').value);
            maxEpisodes = parseInt(document.getElementById('episodes').value);

            dab = new DABConverter(V1, V2, Lk, fs, n, Pnom);

            isRunning = true;
            currentEpisode = 0;
            optimizationData = [];

            document.getElementById('statusValue').textContent = 'RUNNING';
            document.getElementById('statusValue').className = 'status-value running';

            intervalId = setInterval(optimizationStep, 50);
        }

        function stopOptimization() {
            isRunning = false;
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }

            document.getElementById('statusValue').textContent = 'STOPPED';
            document.getElementById('statusValue').className = 'status-value';
        }

        function resetOptimization() {
            stopOptimization();
            optimizationData = [];
            currentEpisode = 0;

            document.getElementById('statusValue').textContent = 'READY';
            document.getElementById('statusValue').className = 'status-value';
            document.getElementById('episodeValue').textContent = '0';
            document.getElementById('powerValue').textContent = '0';
            document.getElementById('rewardValue').textContent = '0';
            document.getElementById('d1Value').textContent = '0.000';
            document.getElementById('d2Value').textContent = '0.000';
            document.getElementById('d3Value').textContent = '0.000';
            document.getElementById('currentValue').textContent = '0.0';

            initializeCharts();
        }

        function optimizationStep() {
            if (!isRunning || currentEpisode >= maxEpisodes) {
                stopOptimization();
                document.getElementById('statusValue').textContent = 'COMPLETED';
                return;
            }

            // Generate random phase shifts (simplified Q-learning simulation)
            const D1 = (Math.random() - 0.5) * 1.0; // -0.5 to 0.5
            const D2 = Math.random() * 0.5; // 0 to 0.5
            const D3 = Math.random() * 0.5; // 0 to 0.5

            const { actual: actualPower } = dab.calculatePower(D1, D2, D3);
            const { actual: rmsCurrent } = dab.calculateRMSCurrent(D1, D2, D3);

            // Calculate reward (simplified)
            const powerError = Math.abs(actualPower - targetPower);
            const reward = Math.exp(-5 * powerError / dab.Pnom) + Math.exp(-2 * rmsCurrent / 10);

            // Store data
            optimizationData.push({
                episode: currentEpisode,
                D1: D1,
                D2: D2,
                D3: D3,
                power: actualPower,
                current: rmsCurrent,
                reward: reward
            });

            // Update displays
            document.getElementById('episodeValue').textContent = currentEpisode;
            document.getElementById('powerValue').textContent = actualPower.toFixed(1);
            document.getElementById('rewardValue').textContent = reward.toFixed(3);
            document.getElementById('d1Value').textContent = D1.toFixed(3);
            document.getElementById('d2Value').textContent = D2.toFixed(3);
            document.getElementById('d3Value').textContent = D3.toFixed(3);
            document.getElementById('currentValue').textContent = rmsCurrent.toFixed(2);

            // Update charts every 10 episodes to avoid performance issues
            if (currentEpisode % 10 === 0) {
                updateCharts();
            }

            currentEpisode++;
        }

        // Initialize dashboard
        window.onload = function () {
            initializeCharts();
        };

        // Handle window resize
        window.addEventListener('resize', function () {
            setTimeout(function () {
                Plotly.Plots.resize('powerChart');
                Plotly.Plots.resize('rewardChart');
                Plotly.Plots.resize('phaseChart');
                Plotly.Plots.resize('currentPowerChart');
                Plotly.Plots.resize('powerHistogram');
                Plotly.Plots.resize('phase3DChart');
            }, 100);
        });
    </script>
</body>

</html>